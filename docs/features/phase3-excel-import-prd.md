# Phase 3: BOM Excel 일괄 Import PRD

**기능명:** BOM 구성품 Excel 일괄 등록  
**목표:** 대량 BOM 데이터 입력 효율화 (수작업 시간 80% 단축)  
**우선순위:** P1 (High)  
**예상 개발 기간:** 2주 (Sprint 1개)

---

## 🎯 목표 및 가치 제안

### 비즈니스 가치

- **시간 절약:** 100개 구성품 등록 시간: 60분 → 10분 (83% 단축)
- **정확도 향상:** 수작업 오타 제거, Excel 검증 기능 활용
- **교육 비용 감소:** 기존 Excel 작업 방식 유지, 학습 곡선 최소화
- **대량 데이터 마이그레이션:** 레거시 시스템 → ERP 이관 가능

### 사용자 페르소나

- **제조 관리자:** 신제품 출시 시 100+ 구성품 일괄 등록
- **구매 담당자:** 공급업체 BOM 데이터 수신 → 시스템 반영
- **데이터 마이그레이션 팀:** 레거시 ERP → 신규 ERP 이관

---

## 📋 기능 요구사항 (Functional Requirements)

### FR-1. Excel 파일 업로드

- **허용 형식:** `.xlsx`, `.xls` (Excel 2007+)
- **최대 파일 크기:** 10MB
- **최대 행 수:** 1,000 rows (1회 업로드 당)
- **업로드 방식:**
  - Drag & Drop
  - 파일 선택 버튼
  - 템플릿 다운로드 링크 제공

**템플릿 구조:**

```
| parent_code | child_code | quantity | unit | notes |
|-------------|------------|----------|------|-------|
| FG-001      | MOD-LCD    | 1        | EA   | LCD 모듈 |
| FG-001      | MOD-POWER  | 1        | EA   | 전원 모듈 |
| MOD-LCD     | PT-PANEL   | 1        | EA   | 액정 패널 |
```

**필수 컬럼:**

- `parent_code` (상위 상품 코드) - SKU 코드
- `child_code` (하위 구성품 코드) - SKU 코드
- `quantity` (수량) - 0 < qty ≤ 9999

**선택 컬럼:**

- `unit` (단위) - 기본값: EA
- `notes` (메모) - 최대 500자

---

### FR-2. 미리보기 단계 (Preview)

업로드 후 데이터 검증 전 사용자 확인 단계

**표시 정보:**

1. **요약 통계**
   - 총 행 수
   - 유효 행 수 (예상)
   - 에러 행 수 (예상)
   - 상위 상품 종류
   - 하위 구성품 종류

2. **데이터 미리보기 (상위 10행)**
   - 원본 데이터 표시
   - 에러 행 하이라이트 (빨간색)
   - 경고 행 하이라이트 (노란색)

3. **액션 버튼**
   - "검증 시작" (다음 단계)
   - "파일 재업로드"
   - "취소"

---

### FR-3. 유효성 검사 (Validation)

#### Level 1: 형식 검증 (즉시 차단)

- [ ] 필수 컬럼 누락 (`parent_code`, `child_code`, `quantity`)
- [ ] 수량 범위 (0 < qty ≤ 9999)
- [ ] 수량 형식 (숫자, 소수점 4자리 이하)
- [ ] 코드 형식 (공백 없음, 특수문자 제한)

**결과:** 에러 → **중단**, 파일 수정 후 재업로드 필요

#### Level 2: 데이터 검증 (경고)

- [ ] 상위 상품 존재 여부 (`items` 테이블 조회)
- [ ] 하위 구성품 존재 여부 (`items` 테이블 조회)
- [ ] 중복 행 (동일 parent-child 조합)
- [ ] 직접 순환 참조 (parent == child)
- [ ] 간접 순환 참조 (A → B → C → A)

**결과:** 경고 → **부분 성공** 가능, 유효한 행만 반영 선택지 제공

#### Level 3: 비즈니스 규칙 (선택적 경고)

- [ ] 동일 parent에 child 중복 (이미 시스템에 존재)
- [ ] 수량이 과도하게 큼 (> 1000)
- [ ] unit이 일반적이지 않음 (EA, KG, M 외)

**결과:** 경고 → 사용자 확인 후 진행

---

### FR-4. 검증 결과 리포트

**성공 행:**

```
✅ 행 1: FG-001 → MOD-LCD (수량: 1 EA)
✅ 행 2: FG-001 → MOD-POWER (수량: 1 EA)
```

**에러 행:**

```
❌ 행 3: FG-001 → PT-NOTFOUND (에러: 구성품 PT-NOTFOUND를 찾을 수 없습니다)
❌ 행 5: FG-001 → FG-001 (에러: 순환 참조 - 자기 자신을 구성품으로 추가할 수 없습니다)
```

**경고 행:**

```
⚠️ 행 4: FG-001 → MOD-LCD (경고: 이미 등록된 구성품입니다. 수량이 업데이트됩니다)
```

**다운로드 옵션:**

- "에러 리포트 다운로드 (Excel)" - 에러/경고 행만 포함
- "전체 결과 다운로드 (Excel)" - 원본 + 검증 결과 컬럼 추가

---

### FR-5. 부분 성공 정책 (결정 필요 #2)

**옵션 A: 전체 성공 또는 전체 실패 (Transactional)**

- 모든 행이 유효해야만 반영
- 1개라도 에러 시 전체 롤백
- **장점:** 데이터 일관성 보장
- **단점:** 재작업 시간 증가

**옵션 B: 부분 성공 허용 (Partial Success)** ✅ 권장

- 유효한 행만 반영, 에러 행은 리포트 제공
- 사용자가 에러 수정 후 재업로드
- **장점:** 대량 데이터 입력 효율↑
- **단점:** 데이터 정합성 주의 필요

**결정:**

- [ ] 옵션 A (전체 성공/실패)
- [x] **옵션 B (부분 성공 허용)** - 권장

---

### FR-6. 확정 반영 (Commit)

**확인 모달:**

```
────────────────────────────────────────
  BOM 일괄 Import 확정
────────────────────────────────────────

✅ 성공: 147 행
❌ 실패: 3 행
⚠️ 경고: 5 행

확정 시 유효한 147개의 구성품이 추가됩니다.
실패한 3개 행은 에러 리포트를 참고하여 수정 후
재업로드 해주세요.

[ 에러 리포트 다운로드 ]

[ 취소 ]  [ 확정 ]
────────────────────────────────────────
```

**확정 시 처리:**

1. 트랜잭션 시작
2. 유효한 행만 `bom_components` 테이블에 INSERT
3. `items.has_bom` 플래그 자동 업데이트
4. 감사 로그 기록 (누가, 언제, 몇 건)
5. 트랜잭션 커밋
6. 사용자에게 성공 토스트 표시

---

### FR-7. 코드 기준 (결정 필요 #1)

**옵션 A: SKU 코드 (code) 기준** ✅ 권장

- Excel에 `FG-001`, `MOD-LCD` 같은 사람이 읽기 쉬운 코드 입력
- 서버에서 `items.sku` → `items.id` 매핑
- **장점:** 현장 편의성↑, Excel 작업 직관적
- **단점:** 코드 중복 시 애매함 (같은 SKU 2개 이상)

**옵션 B: UUID (id) 기준**

- Excel에 `59e04536-0f1f-41a9-...` 같은 UUID 입력
- **장점:** 유일성 보장
- **단점:** 사용자가 UUID 알 수 없음, Excel 작업 어려움

**결정:**

- [x] **옵션 A (SKU 코드 기준)** - 권장
- [ ] 옵션 B (UUID 기준)

**구현 시 주의사항:**

- SKU 중복 시 에러 처리 (예: "SKU FG-001이 2개 이상 존재합니다")
- 대소문자 구분 여부 결정 (권장: 대소문자 무시)

---

### FR-8. 버전 스냅샷 (결정 필요 #3)

**옵션 A: 즉시 반영 (No Versioning)**

- Import 확정 시 바로 Active BOM에 반영
- **장점:** 간단함, 빠른 적용
- **단점:** 롤백 어려움

**옵션 B: Draft 버전 생성 (Versioning)** ✅ 권장 (Phase 4)

- Import 시 Draft 버전으로 생성
- 검토 후 승인 → Active 전환
- 이전 버전 보존 (감사 추적)
- **장점:** 안전성↑, 롤백 가능
- **단점:** 복잡도↑, Phase 4로 미룸 권장

**결정:**

- [x] **옵션 A (즉시 반영)** - Phase 3
- [ ] 옵션 B (Draft 버전) - Phase 4로 이월

---

## 🎨 UI/UX 설계

### 화면 1: Import 진입점

**위치:** 상품 상세 → BOM 구조 탭 → 헤더  
**버튼:** "Excel Import" (아이콘: UploadCloud)

### 화면 2: 파일 업로드 모달

```
┌─────────────────────────────────────────────┐
│  BOM Excel Import                      [X] │
├─────────────────────────────────────────────┤
│                                             │
│   ┌───────────────────────────────────┐   │
│   │                                   │   │
│   │       📁 Drag & Drop             │   │
│   │       파일을 여기에 놓으세요      │   │
│   │                                   │   │
│   │   또는 [ 파일 선택 ] 클릭        │   │
│   └───────────────────────────────────┘   │
│                                             │
│   📥 템플릿 다운로드: [ Excel 템플릿 ]    │
│                                             │
│   ⚠️ 허용 형식: .xlsx, .xls               │
│   ⚠️ 최대 크기: 10MB, 1,000 rows          │
│                                             │
│           [ 취소 ]      [ 다음 ]          │
└─────────────────────────────────────────────┘
```

### 화면 3: 미리보기 및 검증

```
┌─────────────────────────────────────────────┐
│  BOM Excel Import - 미리보기           [X] │
├─────────────────────────────────────────────┤
│  📊 요약                                    │
│    총 행 수: 150                            │
│    유효 행: 147 ✅                          │
│    에러 행: 3 ❌                            │
│                                             │
│  📄 미리보기 (상위 10행)                    │
│  ┌─────────────────────────────────────┐  │
│  │ parent_code | child_code | qty | .. │  │
│  ├─────────────────────────────────────┤  │
│  │ FG-001      | MOD-LCD    | 1   | .. │  │
│  │ FG-001      | MOD-POWER  | 1   | .. │  │
│  │ FG-001      | PT-UNKNOWN | 1   | .. │ ❌
│  └─────────────────────────────────────┘  │
│                                             │
│      [ 파일 재업로드 ]  [ 검증 시작 ]     │
└─────────────────────────────────────────────┘
```

### 화면 4: 검증 결과 및 확정

```
┌─────────────────────────────────────────────┐
│  BOM Excel Import - 검증 완료          [X] │
├─────────────────────────────────────────────┤
│  ✅ 성공: 147 행                            │
│  ❌ 실패: 3 행                              │
│  ⚠️ 경고: 5 행                              │
│                                             │
│  [ 에러 리포트 다운로드 ]                  │
│                                             │
│  ⚠️ 확정 시 유효한 147개 구성품이          │
│     추가됩니다. 실패한 3개는 수정 후       │
│     재업로드 해주세요.                      │
│                                             │
│           [ 취소 ]      [ 확정 ]          │
└─────────────────────────────────────────────┘
```

---

## 🔧 기술 설계

### 프론트엔드

- **라이브러리:** `xlsx` (SheetJS) - Excel 파일 파싱
- **파일 업로드:** `react-dropzone`
- **진행 상태:** Stepper UI (1. 업로드 → 2. 미리보기 → 3. 검증 → 4. 확정)
- **검증 로직:** 클라이언트 1차 검증 + 서버 2차 검증

### 백엔드

- **엔드포인트:** `POST /api/v1/items/bom/import`
- **요청 형식:** `multipart/form-data` (Excel 파일)
- **응답 형식:**

  ```json
  {
    "success": true,
    "data": {
      "total_rows": 150,
      "valid_rows": 147,
      "error_rows": 3,
      "warning_rows": 5,
      "details": [
        {
          "row": 3,
          "status": "error",
          "reason": "component_not_found",
          "message": "구성품 PT-UNKNOWN을 찾을 수 없습니다"
        }
      ]
    }
  }
  ```

- **처리 흐름:**
  1. 파일 수신 및 임시 저장
  2. Excel 파싱 (Python: `openpyxl`)
  3. 각 행 검증 (형식 → 데이터 → 비즈니스 규칙)
  4. 검증 결과 반환 (성공/에러/경고 리스트)
  5. 사용자 확정 시 → 트랜잭션 INSERT

### 데이터베이스

- **임시 테이블:** `bom_import_sessions` (업로드 세션 관리)
  - `id`, `user_id`, `filename`, `total_rows`, `status`, `created_at`
- **감사 로그:** `bom_import_logs`
  - `id`, `session_id`, `user_id`, `action`, `success_count`, `error_count`, `created_at`

---

## 📊 성능 요구사항 (Non-Functional Requirements)

| 지표            | 목표                | 측정 방법          |
| --------------- | ------------------- | ------------------ |
| **파일 업로드** | < 3초 (10MB)        | 실제 네트워크 측정 |
| **파싱 시간**   | < 2초 (1,000 rows)  | 서버 로그          |
| **검증 시간**   | < 5초 (1,000 rows)  | 서버 로그          |
| **확정 시간**   | < 10초 (1,000 rows) | 트랜잭션 시간      |
| **전체 플로우** | < 20초 (1,000 rows) | E2E 측정           |

---

## 🔐 권한 및 감사 (Security & Audit)

### 권한 체크

- **admin:** Import 가능, 모든 상품 대상
- **manager:** Import 가능, 본인 관리 상품만
- **staff:** Import 불가 (또는 Read-only 미리보기만)
- **readonly:** Import 불가

### 감사 로그

**필수 기록 항목:**

- `user_id` (누가)
- `action` (무엇을: import_started, import_committed, import_failed)
- `timestamp` (언제)
- `filename` (파일명)
- `total_rows` (총 행 수)
- `success_count` (성공 행 수)
- `error_count` (에러 행 수)
- `session_id` (세션 ID - 추적용)

**로그 예시:**

```
[2025-10-06 14:32:15] BOM_IMPORT_COMMITTED:
  user=admin, file=bom_batch_001.xlsx,
  total=150, success=147, error=3, session=abc123
```

---

## 🧪 테스트 시나리오

### TS-1. 정상 플로우

1. Excel 템플릿 다운로드
2. 10개 행 입력 (모두 유효)
3. 파일 업로드
4. 미리보기 확인
5. 검증 → 모두 성공
6. 확정 → BOM 트리에 반영 확인

### TS-2. 부분 성공

1. 10개 행 입력 (7개 유효, 3개 에러)
2. 업로드 → 검증
3. 에러 리포트 다운로드
4. 부분 확정 → 7개만 반영
5. 에러 3개 수정 후 재업로드 → 성공

### TS-3. 순환 참조 감지

1. A → B, B → C, C → A (순환) 입력
2. 검증 → 순환 참조 에러 감지
3. 해당 행 하이라이트
4. 수정 후 재검증

### TS-4. 중복 행 처리

1. 동일 parent-child 2번 입력
2. 검증 → 중복 경고
3. 확정 시 첫 번째 행만 반영 (또는 수량 합산 옵션)

### TS-5. 대량 데이터 (1,000 rows)

1. 1,000개 행 입력
2. 업로드 → 진행 바 표시
3. 검증 < 5초
4. 확정 < 10초
5. 성능 목표 달성 확인

---

## 📅 개발 일정

### Week 1: 기반 작업

- Day 1-2: 프론트엔드 파일 업로드 UI
- Day 3-4: 백엔드 파싱 및 검증 로직
- Day 5: 통합 테스트

### Week 2: 고도화 및 QA

- Day 6-7: 미리보기 및 검증 결과 UI
- Day 8-9: 부분 성공 로직 및 감사 로그
- Day 10: E2E 테스트 및 버그 수정

**예상 공수:** 2 FTE (Frontend 1 + Backend 1) × 2주

---

## 🚀 배포 계획

### Phase 3.1: MVP (Week 1-2)

- ✅ 기본 Import 기능
- ✅ 형식/데이터 검증
- ✅ 부분 성공 허용
- ✅ 에러 리포트

### Phase 3.2: 고도화 (Week 3-4)

- 수량 업데이트 옵션 (기존 구성품 수량 변경)
- Excel 내 계산식 지원
- 일괄 삭제 기능

### Phase 4: 버전 관리 (Future)

- Draft/Active/Archived 버전
- 승인 워크플로우
- 버전 비교 (Diff)

---

## ❓ 미결정 사항 (Decision Points)

### 1. 코드 기준

- [x] **SKU 코드 (권장)** - 현장 편의성
- [ ] UUID - 유일성 보장

### 2. 부분 성공 정책

- [ ] 전체 성공/실패 (Transactional)
- [x] **부분 성공 허용 (권장)** - 효율성

### 3. 버전 스냅샷

- [x] **즉시 반영 (Phase 3)** - 빠른 구현
- [ ] Draft 버전 (Phase 4) - 안전성

### 4. 중복 행 처리

- [ ] 첫 번째 행만 반영 (기본값)
- [ ] 수량 합산 (예: 1 EA + 1 EA = 2 EA)
- [ ] 사용자 선택 (Phase 3.2)

### 5. 기존 구성품 처리

- [ ] Skip (에러 처리)
- [ ] 수량 업데이트 (덮어쓰기)
- [ ] 사용자 선택 (Phase 3.2)

---

## 📌 다음 액션

### 즉시 (이번 주)

1. [ ] PRD 검토 및 승인 (Product Manager)
2. [ ] 미결정 사항 결정 (Stakeholder Meeting)
3. [ ] Excel 템플릿 초안 작성
4. [ ] 기술 스펙 상세화 (Dev Lead)

### 다음 주

1. [ ] Sprint 계획 (Dev Team)
2. [ ] UI 목업 작성 (Designer)
3. [ ] 개발 시작 (Week 1)

---

**문서 버전:** v1.0 (Draft)  
**최종 수정:** 2025-10-06  
**작성자:** Product Team  
**검토자:** Dev Lead, QA Lead  
**승인자:** (보류)
